<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Group Survey í…ŒìŠ¤íŠ¸</title>
    <script>
        let ageGroupSurveys = [];
        let targetGroupSurveys = [];

        function renderSurveyList(surveys, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = "";

            surveys.forEach((survey, idx) => {
                const div = document.createElement("div");
                div.innerHTML = `
                    <p><strong>ë¬¸í•­ ${idx + 1}:</strong> ${survey.question}</p>
                    <div>
                        <label><input type="radio" name="${containerId}-answer-${idx}" value="1"> ${survey.answer1}</label>
                        <label><input type="radio" name="${containerId}-answer-${idx}" value="2"> ${survey.answer2}</label>
                        <label><input type="radio" name="${containerId}-answer-${idx}" value="3"> ${survey.answer3}</label>
                        <label><input type="radio" name="${containerId}-answer-${idx}" value="4"> ${survey.answer4}</label>
                        <label><input type="radio" name="${containerId}-answer-${idx}" value="5"> ${survey.answer5}</label>
                    </div><hr>
                `;
                container.appendChild(div);
            });
        }

        function submitSurvey(surveys, containerId, ageGroup) {
            const answers = [];
            for (let i = 0; i < surveys.length; i++) {
                const radios = document.getElementsByName(`${containerId}-answer-${i}`);
                let selected = -1;
                for (const radio of radios) {
                    if (radio.checked) selected = parseInt(radio.value);
                }
                if (selected === -1) {
                    alert(`${i + 1}ë²ˆ ë¬¸í•­ì— ì‘ë‹µí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`);
                    return;
                }
                answers.push(selected);
            }

            fetch("/api/group-surveys/submit", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ ageGroup: ageGroup, answers: answers })
            })
            .then(res => res.json())
            .then(res => {
                if (!res.success) throw new Error("ì‘ë‹µ ì˜¤ë¥˜");
                alert("ğŸ“Š ìœ„í—˜ë„ ë¶„ì„ ê²°ê³¼\n\nì´ì : " + res.data.totalRiskScore.toFixed(2) + "\n" +
                    Object.entries(res.data.categoryScores)
                          .map(([cat, score]) => `${cat}: ${score.toFixed(2)}ì `)
                          .join("\n")
                );
            })
            .catch(err => {
                alert("ì œì¶œ ì‹¤íŒ¨");
                console.error(err);
            });
        }

        window.onload = () => {
            document.getElementById("loadAgeBtn").addEventListener("click", () => {
                const ageGroup = document.getElementById("ageGroup").value;
                if (!ageGroup) return alert("ì—°ë ¹ëŒ€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");

                fetch(`/api/group-surveys/by-age/${ageGroup}`)
                    .then(res => res.json())
                    .then(res => {
                        if (!res.success) throw new Error();
                        ageGroupSurveys = res.data;
                        renderSurveyList(ageGroupSurveys, "ageSurveyContainer");
                        document.getElementById("ageSubmitBtn").onclick = () =>
                            submitSurvey(ageGroupSurveys, "ageSurveyContainer", ageGroup);
                    })
                    .catch(err => alert("ageGroup ë¬¸ì§„ ë¡œë“œ ì‹¤íŒ¨"));
            });

            document.getElementById("loadTargetBtn").addEventListener("click", () => {
                const targetGroup = document.getElementById("targetGroup").value;
                if (!targetGroup) return alert("ëŒ€ìƒ ê·¸ë£¹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

                fetch(`/api/group-surveys/by-target/${targetGroup}`)
                    .then(res => res.json())
                    .then(res => {
                        if (!res.success) throw new Error();
                        targetGroupSurveys = res.data;
                        renderSurveyList(targetGroupSurveys, "targetSurveyContainer");
                        document.getElementById("targetSubmitBtn").onclick = () =>
                            submitSurvey(targetGroupSurveys, "targetSurveyContainer", targetGroupSurveys[0]?.ageGroup || "5ì„¸");
                    })
                    .catch(err => alert("targetGroup ë¬¸ì§„ ë¡œë“œ ì‹¤íŒ¨"));
            });
        };
    </script>
</head>
<body>
<h2>âœ… Group Survey í…ŒìŠ¤íŠ¸</h2>

<!-- AgeGroup ì˜ì—­ -->
<section style="border:1px solid #ccc; padding:10px; margin-bottom:20px;">
    <h3>â‘  ì—°ë ¹ëŒ€ ë¬¸ì§„</h3>
    <label for="ageGroup">ì—°ë ¹ëŒ€ ì„ íƒ:</label>
    <select id="ageGroup">
        <option value="">-- ì„ íƒ --</option>
        <option value="0~12ê°œì›”">0~12ê°œì›”</option>
        <option value="1~2ì„¸">1~2ì„¸</option>
        <option value="3~4ì„¸">3~4ì„¸</option>
        <option value="5ì„¸">5ì„¸</option>
    </select>
    <button id="loadAgeBtn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <div id="ageSurveyContainer"></div>
    <button id="ageSubmitBtn">ì œì¶œ</button>
</section>

<!-- TargetGroup ì˜ì—­ -->
<section style="border:1px solid #ccc; padding:10px;">
    <h3>â‘¡ ëŒ€ìƒ ê·¸ë£¹ ë¬¸ì§„</h3>
    <label for="targetGroup">ëŒ€ìƒ ì„ íƒ:</label>
    <select id="targetGroup">
        <option value="">-- ì„ íƒ --</option>
        <option value="ìœ ì¹˜ì›A">ìœ ì¹˜ì›A</option>
        <option value="ìœ ì¹˜ì›B">ìœ ì¹˜ì›B</option>
        <option value="ì–´ë¦°ì´ì§‘C">ì–´ë¦°ì´ì§‘C</option>
        <option value="ìœ ì¹˜ì›D">ìœ ì¹˜ì›D</option>
        <option value="ìœ ì¹˜ì›E">ìœ ì¹˜ì›E</option>
    </select>
    <button id="loadTargetBtn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <div id="targetSurveyContainer"></div>
    <button id="targetSubmitBtn">ì œì¶œ</button>
</section>
</body>
</html>
