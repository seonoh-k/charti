<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/default_layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charti</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap"
          rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
    </style>
</head>
<th:block layout:fragment="content">
<h1 class="text-2xl font-bold mb-4">ë°ì¼ë¦¬ ë¬¸ì§„</h1>

<!-- ì—°ë ¹ëŒ€ ì„ íƒ -->
<label for="ageGroup" class="block mb-2 font-semibold">ì—°ë ¹ëŒ€ ì„ íƒ:</label>
<select id="ageGroup" class="border p-2 rounded mb-4">
    <option value="">-- ì—°ë ¹ëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
    <option value="0~12ê°œì›”">0~12ê°œì›”</option>
    <option value="1~2ì„¸">1~2ì„¸</option>
    <option value="3~4ì„¸">3~4ì„¸</option>
    <option value="5ì„¸">5ì„¸</option>
</select>

<!-- ì§ˆë¬¸ ì¶œë ¥ -->
<div id="survey-container" class="mb-4"></div>

<!-- ì œì¶œ ë²„íŠ¼ -->
<button onclick="submitSurvey()"
        class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">
    ì œì¶œí•˜ê¸°
</button>

<script>
    const surveyContainer = document.getElementById("survey-container");
    const ageGroupSelect = document.getElementById("ageGroup");
    let surveys = [];

    ageGroupSelect.addEventListener("change", () => {
        const selectedAgeGroup = ageGroupSelect.value;
        if (selectedAgeGroup) {
            fetch(`/api/surveys/${selectedAgeGroup}`)
                .then(response => response.json())
                .then(data => {
                    surveys = data;
                    renderSurveys();
                })
                .catch(error => {
                    console.error(error);
                    alert("ë¬¸ì§„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                });
        } else {
            surveyContainer.innerHTML = "";
        }
    });

    function renderSurveys() {
        surveyContainer.innerHTML = "";
        surveys.forEach((survey, index) => {
            const questionDiv = document.createElement("div");
            questionDiv.className = "mb-4";
            questionDiv.innerHTML = `
                <p class="font-semibold mb-2">Q${index + 1}. ${survey.question}</p>
                <label><input type="radio" name="q${survey.id}" value="1"> ${survey.answer1}</label><br>
                <label><input type="radio" name="q${survey.id}" value="2"> ${survey.answer2}</label><br>
                <label><input type="radio" name="q${survey.id}" value="3"> ${survey.answer3}</label><br>
                <label><input type="radio" name="q${survey.id}" value="4"> ${survey.answer4}</label><br>
                <label><input type="radio" name="q${survey.id}" value="5"> ${survey.answer5}</label><br>
            `;
            surveyContainer.appendChild(questionDiv);
        });
    }

function submitSurvey() {
    const answers = [];
    let allAnswered = true;

    surveys.forEach(survey => {
        const selected = document.querySelector(`input[name="q${survey.id}"]:checked`);
        if (selected) {
            answers.push(parseInt(selected.value));
        } else {
            allAnswered = false;
        }
    });

    // ğŸ” 1ï¸âƒ£ answers ë°°ì—´ í™•ì¸
    console.log("answers ë°°ì—´ >>>", answers);

    if (!answers || answers.length === 0) {
        alert("ëª¨ë“  ì§ˆë¬¸ì— ë‹µë³€í•´ì£¼ì„¸ìš”!");
        return;
    }

    // ğŸ” 2ï¸âƒ£ ì„œë²„ë¡œ ì „ì†¡í•  ë°ì´í„° í™•ì¸
    console.log("ì„œë²„ë¡œ ì „ì†¡í•  ë°ì´í„°:", {
        ageGroup: ageGroupSelect.value,
        answers: answers
    });

    fetch("/api/surveys/submit", {
        method: "POST",
        headers: {
            "Content-Type": "application/json; charset=UTF-8"
        },
        body: JSON.stringify({
            ageGroup: ageGroupSelect.value,
            answers: answers
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${response.status})`);
        }
        return response.json();
    })
    .then(data => {
        console.log("ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°:", data);
        const riskScores = encodeURIComponent(JSON.stringify(data));
        const answersParam = encodeURIComponent(JSON.stringify(answers));
        window.location.href = `/daily-survey-result?ageGroup=${encodeURIComponent(ageGroupSelect.value)}&riskScores=${riskScores}&answers=${answersParam}`;
    })
    .catch(error => {
        console.error(error);
        alert("ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    });
}

</script>
</th:block>
</html>
